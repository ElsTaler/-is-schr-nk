<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bernds Eisschrank-Profi</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 500px; margin: 20px auto; background: #eef2f3; padding: 15px; }
        #login-screen { text-align: center; margin-top: 100px; }
        #main-content { display: none; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; text-align: center; margin-bottom: 20px; }
        .search-box { background: #fffde7; border: 2px solid #fdd835; padding: 12px; width: 100%; border-radius: 10px; font-size: 16px; box-sizing: border-box; margin-bottom: 25px; }
        .input-group { background: #f8f9fa; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 30px; }
        
        label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-top: 10px; margin-bottom: 2px; }
        
        .input-row { display: flex; gap: 10px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        #menge { width: 90px; }
        button { width: 100%; padding: 15px; background: #1a73e8; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        .fach-header { background: #34ace0; color: white; padding: 10px 15px; border-radius: 8px; margin-top: 20px; font-weight: bold; font-size: 13px; text-transform: uppercase; }
        .item { background: white; padding: 12px; margin: 8px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #1a73e8; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .date-container { font-size: 11px; color: #666; margin-top: 4px; line-height: 1.4; }
        .controls { display: flex; gap: 8px; }
        .minus-btn { background: #fff176; color: #5d4037; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .del-btn { background: #ff5252; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-screen" class="card">
    <h2>‚ùÑÔ∏è Zugang gesch√ºtzt</h2>
    <p>Bitte PIN eingeben:</p>
    <input type="password" id="pinInput" placeholder="PIN" style="text-align: center;">
    <button onclick="checkPin()">√ñffnen</button>
</div>

<div id="main-content">
    <div class="card">
        <h2>‚ùÑÔ∏è Mein Eisschrank</h2>
        
        <input type="text" id="searchInput" class="search-box" placeholder="üîé Suchen..." onkeyup="filterData()">

        <div class="input-group">
            <label>ARTIKELNAME & MENGE</label>
            <div class="input-row">
                <input type="text" id="name" placeholder="z.B. Erbsen">
                <input type="number" id="menge" value="1" min="1">
            </div>

            <div class="input-row">
                <div style="flex: 1;">
                    <label>EINFRIERDATUM</label>
                    <input type="date" id="freezeDate">
                </div>
                <div style="flex: 1;">
                    <label>HALTBAR BIS</label>
                    <input type="date" id="mhdDate">
                </div>
            </div>

            <label>FACH / EBENE</label>
            <select id="ebene">
                <option value="Ebene 1 (Fach)">Ebene 1 (Fach)</option>
                <option value="Ebene 2">Ebene 2</option>
                <option value="Ebene 3">Ebene 3</option>
                <option value="Ebene 4">Ebene 4</option>
                <option value="Ebene 5">Ebene 5</option>
                <option value="Ebene 6 (kleine Schublade)">Ebene 6 (kleine Schublade)</option>
            </select>
            <button onclick="sendData()">Hinzuf√ºgen</button>
        </div>

        <div id="display">Lade Best√§nde...</div>
        <button onclick="logout()" style="background: #999; margin-top: 30px; padding: 8px; font-size: 12px;">Abmelden</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx95Jepa2ML_z3GUJj6zTuaOjX1cwGkWiD3T90zicTuQm21THmjsrNz6uoJjFzB7TmuaQ/exec"; // <--- URL HIER EINSETZEN
    const CORRECT_PIN = "1908";
    let allData = [];

    function checkPin() {
        if (document.getElementById('pinInput').value === CORRECT_PIN) {
            localStorage.setItem('eisschrank_access', 'granted');
            showApp();
        } else { alert("Falsche PIN!"); }
    }

    function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        loadData();
    }

    function logout() { localStorage.removeItem('eisschrank_access'); location.reload(); }

    if (localStorage.getItem('eisschrank_access') === 'granted') { showApp(); }

    async function sendData() {
        const name = document.getElementById('name').value;
        const menge = document.getElementById('menge').value;
        const freeze = document.getElementById('freezeDate').value;
        const mhd = document.getElementById('mhdDate').value;
        const ebene = document.getElementById('ebene').value;
        if(!name) return;
        const dateCombined = "E:" + freeze + "|M:" + mhd;
        const vollerName = menge + "x " + name;
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "add", name: vollerName, date: dateCombined, ebene: ebene}) });
        document.getElementById('name').value = "";
        document.getElementById('freezeDate').value = "";
        document.getElementById('mhdDate').value = "";
        loadData();
    }

    async function changeQty(fullName, currentEbene, dateCombined) {
        let parts = fullName.split("x ");
        let qty = parseInt(parts[0]);
        let itemName = parts.slice(1).join("x ");
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "delete", name: fullName}) });
        if (qty > 1) {
            let newName = (qty - 1) + "x " + itemName;
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "add", name: newName, date: dateCombined, ebene: currentEbene}) });
        }
        loadData();
    }

    async function deleteItem(name) {
        if(!confirm(name + " l√∂schen?")) return;
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "delete", name: name}) });
        loadData();
    }

    async function loadData() {
        const response = await fetch(SCRIPT_URL);
        let data = await response.json();
        allData = data.filter(row => row[0] && row[0] !== "Name");
        filterData();
    }

    function formatDate(isoStr) {
        if (!isoStr || isoStr === "undefined" || isoStr === "") return "-";
        const d = new Date(isoStr);
        return isNaN(d) ? "-" : d.toLocaleDateString('de-DE');
    }

    function filterData() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const display = document.getElementById('display');
        let filtered = allData.filter(row => row[0].toLowerCase().includes(searchTerm));
        
        filtered.sort((a, b) => {
            const ebeneA = a[2] || "";
            const ebeneB = b[2] || "";
            return ebeneA.localeCompare(ebeneB, undefined, {numeric: true, sensitivity: 'base'});
        });

        let html = "";
        let aktuellesFach = "";
        const heute = new Date();
        const vorEinemJahr = new Date();
        vorEinemJahr.setFullYear(heute.getFullYear() - 1);

        filtered.forEach(row => {
            if (row[2] !== aktuellesFach) {
                aktuellesFach = row[2];
                html += `<div class="fach-header">${aktuellesFach}</div>`;
            }

            const dateParts = row[1].split("|");
            const eDateStr = dateParts[0] ? dateParts[0].replace("E:", "") : "";
            const mDateStr = dateParts[1] ? dateParts[1].replace("M:", "") : "";
            
            const eDate = eDateStr ? new Date(eDateStr) : null;
            const mDate = mDateStr ? new Date(mDateStr) : null;

            let bgColor = "white";
            let warnText = "";

            if (mDate && mDate <= heute) {
                bgColor = "#ffebee";
                warnText = "‚ö†Ô∏è MHD!";
            } else if (eDate && eDate <= vorEinemJahr) {
                bgColor = "#fff9c4";
                warnText = "üßä > 1 Jahr!";
            }

            html += `<div class="item" style="background-color: ${bgColor};">
                        <div>
                            <strong>${row[0]} <span style="color:red; font-size:10px;">${warnText}</span></strong>
                            <div class="date-container">
                                ${eDateStr ? '‚ùÑÔ∏è Eingefroren: ' + formatDate(eDateStr) : ''}
                                ${eDateStr && mDateStr ? '<br>' : ''}
                                ${mDateStr ? 'üïí Haltbar bis: ' + formatDate(mDateStr) : ''}
                            </div>
                        </div>
                        <div class="controls">
                            <button class="minus-btn" onclick="changeQty('${row[0]}', '${row[2]}', '${row[1]}')">-1</button>
                            <button class="del-btn" onclick="deleteItem('${row[0]}')">üóëÔ∏è</button>
                        </div>
                     </div>`;
        });
        display.innerHTML = html || "Eisschrank leer.";
    }
</script>
</body>
</html>